{% extends 'base.html' %}

{% block title %}{{ workflow.name }} - Q360 ERP{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a
        href="{% url 'workflow-list' %}">Workflows</a></li>
<li class="breadcrumb-item active">{{ workflow.name }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div
                class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">{{ workflow.name
                    }}</h6>
                <div class="btn-group">
                    <a href="{% url 'workflow-update' workflow.id %}"
                        class="btn btn-warning btn-sm">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                    <button class="btn btn-success btn-sm dropdown-toggle"
                        type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-play me-1"></i> Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"
                                onclick="activateWorkflow({{ workflow.id }})">Activate</a></li>
                        <li><a class="dropdown-item" href="#"
                                onclick="deactivateWorkflow({{ workflow.id }})">Deactivate</a></li>
                        <li><a class="dropdown-item" href="#"
                                onclick="cloneWorkflow({{ workflow.id }})">Clone</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Workflow Details</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th style="width: 150px;">Name:</th>
                                <td>{{ workflow.name }}</td>
                            </tr>
                            <tr>
                                <th>Description:</th>
                                <td>{{ workflow.description|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Model:</th>
                                <td>{{ workflow.model }}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    <span
                                        class="badge bg-{% if workflow.status == 'active' %}success{% elif workflow.status == 'inactive' %}danger{% else %}secondary{% endif %}">
                                        {{ workflow.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Created By:</th>
                                <td>{{
                                    workflow.created_by.get_full_name|default:"-"
                                    }}</td>
                            </tr>
                            <tr>
                                <th>Created At:</th>
                                <td>{{ workflow.created_at|date:"d.m.Y H:i"
                                    }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Workflow Diagram</h5>
                        <div class="workflow-diagram" id="workflowDiagram">
                            <!-- Workflow diagram will be rendered here -->
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">States</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for state in workflow.states.all %}
                                    <tr>
                                        <td>
                                            <span class="badge"
                                                style="background-color: {{ state.color }}">
                                                {{ state.name }}
                                            </span>
                                        </td>
                                        <td>{{ state.description|default:"-"
                                            }}</td>
                                        <td>
                                            {% if state.is_initial %}
                                            <span
                                                class="badge bg-info">Initial</span>
                                            {% endif %}
                                            {% if state.is_final %}
                                            <span
                                                class="badge bg-success">Final</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a
                                                    href="{% url 'state-update' state.id %}"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button
                                                    class="btn btn-sm btn-outline-danger delete-state"
                                                    data-id="{{ state.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center">No
                                            states defined</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <a
                                href="{% url 'state-create' %}?workflow={{ workflow.id }}"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i> Add State
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Transitions</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transition in
                                    workflow.transitions.all %}
                                    <tr>
                                        <td>{{ transition.name }}</td>
                                        <td>{{ transition.from_state.name
                                            }}</td>
                                        <td>{{ transition.to_state.name }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a
                                                    href="{% url 'transition-update' transition.id %}"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button
                                                    class="btn btn-sm btn-outline-danger delete-transition"
                                                    data-id="{{ transition.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center">No
                                            transitions defined</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <a
                                href="{% url 'transition-create' %}?workflow={{ workflow.id }}"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i> Add Transition
                            </a>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <h5 class="mb-3">Workflow Instances</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered"
                                id="instancesTable">
                                <thead>
                                    <tr>
                                        <th>Object</th>
                                        <th>Current State</th>
                                        <th>Status</th>
                                        <th>Started By</th>
                                        <th>Started At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for instance in workflow.instances.all %}
                                    <tr>
                                        <td>{{ instance.content_object }}</td>
                                        <td>
                                            <span class="badge"
                                                style="background-color: {{ instance.current_state.color }}">
                                                {{ instance.current_state.name
                                                }}
                                            </span>
                                        </td>
                                        <td>
                                            <span
                                                class="badge bg-{% if instance.status == 'active' %}primary{% elif instance.status == 'completed' %}success{% elif instance.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                                {{ instance.get_status_display
                                                }}
                                            </span>
                                        </td>
                                        <td>{{
                                            instance.started_by.get_full_name|default:"-"
                                            }}</td>
                                        <td>{{
                                            instance.started_at|date:"d.m.Y H:i"
                                            }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a
                                                    href="{% url 'workflow-instance-detail' instance.id %}"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if instance.status ==
                                                'active' %}
                                                <button
                                                    class="btn btn-sm btn-outline-danger cancel-workflow"
                                                    data-id="{{ instance.id }}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">No
                                            instances found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#startWorkflowModal">
                                <i class="fas fa-play me-1"></i> Start Workflow
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start Workflow Modal -->
<div class="modal fade" id="startWorkflowModal" tabindex="-1"
    aria-labelledby="startWorkflowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="startWorkflowModalLabel">Start
                    Workflow</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="startWorkflowForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="contentType" class="form-label">Content
                            Type</label>
                        <select class="form-select" id="contentType"
                            name="content_type_id" required>
                            <option value>Select a content type</option>
                            {% for ct in content_types %}
                            <option value="{{ ct.id }}">{{
                                ct.model_class|capfirst }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="objectId" class="form-label">Object
                            ID</label>
                        <input type="number" class="form-control" id="objectId"
                            name="object_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="data" class="form-label">Data (JSON)</label>
                        <textarea class="form-control" id="data" name="data"
                            rows="3">{}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary"
                    onclick="startWorkflow({{ workflow.id }})">Start</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1"
    aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm
                    Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger"
                    id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize DataTable
    $(document).ready(function() {
        $('#instancesTable').DataTable({
            language: {
                url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/az.json"
            },
            pageLength: 10,
            responsive: true
        });
        
        // Draw workflow diagram
        drawWorkflowDiagram();
        
        // Delete state
        $('.delete-state').click(function() {
            const stateId = $(this).data('id');
            $('#confirmDelete').attr('onclick', `deleteState(${stateId})`);
            $('#deleteModal').modal('show');
        });
        
        // Delete transition
        $('.delete-transition').click(function() {
            const transitionId = $(this).data('id');
            $('#confirmDelete').attr('onclick', `deleteTransition(${transitionId})`);
            $('#deleteModal').modal('show');
        });
        
        // Cancel workflow
        $('.cancel-workflow').click(function() {
            const instanceId = $(this).data('id');
            if (confirm('Are you sure you want to cancel this workflow instance?')) {
                cancelWorkflow(instanceId);
            }
        });
    });
    
    // Draw workflow diagram
    function drawWorkflowDiagram() {
        const container = document.getElementById('workflowDiagram');
        
        // This would use a library like D3.js, vis.js, or Flowchart.js
        // For now, just show a placeholder
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Workflow diagram will be rendered here. This requires a JavaScript library like D3.js or vis.js.
            </div>
        `;
        
        // In a real implementation, you would:
        // 1. Fetch states and transitions
        // 2. Create nodes for states
        // 3. Create edges for transitions
        // 4. Render the diagram
    }
    
    // Activate workflow
    function activateWorkflow(workflowId) {
        fetch(`/api/workflows/${workflowId}/activate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data) {
                alert('Workflow activated successfully');
                location.reload();
            } else {
                alert('Failed to activate workflow');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to activate workflow');
        });
    }
    
    // Deactivate workflow
    function deactivateWorkflow(workflowId) {
        fetch(`/api/workflows/${workflowId}/deactivate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data) {
                alert('Workflow deactivated successfully');
                location.reload();
            } else {
                alert('Failed to deactivate workflow');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to deactivate workflow');
        });
    }
    
    // Clone workflow
    function cloneWorkflow(workflowId) {
        const name = prompt('Enter a name for the cloned workflow:');
        if (name) {
            fetch(`/api/workflows/${workflowId}/clone/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('Workflow cloned successfully');
                    window.location.href = `/workflows/${data.id}/`;
                } else {
                    alert('Failed to clone workflow');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to clone workflow');
            });
        }
    }
    
    // Start workflow
    function startWorkflow(workflowId) {
        const form = document.getElementById('startWorkflowForm');
        const formData = new FormData(form);
        
        fetch(`/api/workflows/${workflowId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                alert('Workflow started successfully');
                $('#startWorkflowModal').modal('hide');
                location.reload();
            } else {
                alert('Failed to start workflow');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to start workflow');
        });
    }
    
    // Delete state
    function deleteState(stateId) {
        fetch(`/api/states/${stateId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                alert('State deleted successfully');
                location.reload();
            } else {
                alert('Failed to delete state');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete state');
        });
    }
    
    // Delete transition
    function deleteTransition(transitionId) {
        fetch(`/api/transitions/${transitionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Transition deleted successfully');
                location.reload();
            } else {
                alert('Failed to delete transition');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete transition');
        });
    }
    
    // Cancel workflow
    function cancelWorkflow(instanceId) {
        fetch(`/api/workflow-instances/${instanceId}/cancel/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data) {
                alert('Workflow cancelled successfully');
                location.reload();
            } else {
                alert('Failed to cancel workflow');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to cancel workflow');
        });
    }
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}